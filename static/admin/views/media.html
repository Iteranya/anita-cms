<div x-data="mediaManager" class="flex flex-col h-full">
    
    <!-- HEADER -->
    <header class="bg-white border-b border-slate-200 h-16 flex items-center justify-between px-8 shadow-sm z-10 flex-shrink-0">
        <div>
            <h1 class="text-xl font-bold text-slate-800">Media Library</h1>
            <p class="text-xs text-slate-500">Manage images and assets</p>
        </div>
        <button @click="openUpload()" class="bg-slate-900 hover:bg-slate-800 text-white px-4 py-2 rounded-lg shadow-lg font-bold text-sm flex items-center">
            <i class="fas fa-cloud-upload-alt mr-2"></i> Upload
        </button>
    </header>

    <!-- CONTENT -->
    <div class="flex-1 overflow-y-auto p-8 custom-scrollbar">
        
        <!-- 3-WAY FILTER TABS -->
        <div class="flex gap-2 mb-6 bg-white p-1 rounded-lg border border-slate-200 inline-flex shadow-sm">
            <button @click="activeTab = 'all'" 
                :class="activeTab === 'all' ? 'bg-slate-800 text-white shadow' : 'text-slate-500 hover:bg-slate-50'"
                class="px-4 py-1.5 rounded-md text-xs font-bold transition">
                All Files
            </button>
            <button @click="activeTab = 'registered'" 
                :class="activeTab === 'registered' ? 'bg-green-600 text-white shadow' : 'text-slate-500 hover:bg-slate-50'"
                class="px-4 py-1.5 rounded-md text-xs font-bold transition">
                Registered
            </button>
            <button @click="activeTab = 'unregistered'" 
                :class="activeTab === 'unregistered' ? 'bg-amber-500 text-white shadow' : 'text-slate-500 hover:bg-slate-50'"
                class="px-4 py-1.5 rounded-md text-xs font-bold transition">
                Unregistered
            </button>
        </div>

        <div x-show="isLoading" class="flex justify-center py-20">
            <i class="fas fa-circle-notch fa-spin text-4xl text-anita-500"></i>
        </div>

        <!-- GRID -->
        <div x-show="!isLoading" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6 animate-fade-in" x-cloak>
            
            <template x-for="f in files" :key="f.filename">
                <!-- LOGIC: Show if ALL OR (Reg & hasMeta) OR (Unreg & !hasMeta) -->
                <div x-show="activeTab === 'all' || (activeTab === 'registered' && metaMap[f.filename]) || (activeTab === 'unregistered' && !metaMap[f.filename])"
                     @click="openDetails(f.filename)"
                     class="group relative bg-white rounded-xl shadow-sm border border-slate-200 aspect-square cursor-pointer overflow-hidden hover:shadow-md transition hover:-translate-y-1">
                    
                    <img :src="'/media/' + f.filename" loading="lazy" class="w-full h-full object-cover">
                    
                    <!-- Icon Badge -->
                    <div class="absolute top-2 right-2 bg-white/90 rounded-full w-6 h-6 flex items-center justify-center shadow-sm text-xs z-10">
                        <i class="fas" :class="metaMap[f.filename] ? 'fa-check-circle text-green-500' : 'fa-exclamation-circle text-amber-500'"></i>
                    </div>

                    <div class="absolute inset-0 bg-slate-900/70 opacity-0 group-hover:opacity-100 transition duration-200 flex flex-col justify-end p-3">
                        <p class="text-white font-bold text-sm truncate" x-text="getDisplayData(f.filename).title"></p>
                        <p class="text-slate-300 text-[10px] truncate font-mono" x-text="f.filename"></p>
                    </div>
                </div>
            </template>

            <!-- Empty State Helper -->
             <div x-show="files.length === 0" class="col-span-full text-center py-10 text-slate-400">
                <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">
                    <i class="fas fa-images"></i>
                </div>
                <p>No media files found.</p>
            </div>
        </div>
    </div>

    <!-- UPLOAD MODAL -->
    <div x-show="uploadModalOpen" class="fixed inset-0 z-50 flex items-center justify-center px-4" x-cloak>
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" @click="uploadModalOpen = false"></div>
        <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden animate-slide-up">
            
            <div class="px-6 py-4 bg-slate-50 border-b border-slate-200 flex justify-between items-center">
                <h3 class="font-bold text-slate-800">Upload Media</h3>
                <button @click="uploadModalOpen = false"><i class="fas fa-times text-slate-400"></i></button>
            </div>

            <div class="p-6 space-y-4">
                <!-- Drop Zone -->
                <label class="block w-full h-32 border-2 border-dashed border-slate-300 rounded-xl hover:bg-slate-50 cursor-pointer flex flex-col items-center justify-center transition"
                       :class="uploadFile ? 'border-anita-500 bg-anita-50' : ''">
                    <input type="file" id="mm-file-input" class="hidden" accept="image/*" @change="handleFileSelect">
                    <i class="fas fa-cloud-upload-alt text-3xl mb-2" :class="uploadFile ? 'text-anita-500' : 'text-slate-400'"></i>
                    <span class="text-xs font-bold text-slate-500" x-text="uploadFile ? uploadFile.name : 'Click to select file'"></span>
                </label>

                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Friendly Name</label>
                    <input type="text" x-model="uploadMeta.title" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm outline-none focus:border-anita-500">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Description</label>
                    <textarea x-model="uploadMeta.description" rows="2" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm outline-none focus:border-anita-500"></textarea>
                </div>

                <button @click="doUpload" :disabled="!uploadFile || isUploading" class="w-full py-2 bg-slate-900 text-white font-bold rounded-lg disabled:opacity-50 flex justify-center items-center">
                    <span x-show="!isUploading">Upload & Save</span>
                    <i x-show="isUploading" class="fas fa-circle-notch fa-spin"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- DETAILS / EDIT MODAL -->
    <div x-show="detailsModalOpen" class="fixed inset-0 z-50 flex items-center justify-center px-4" x-cloak>
        <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-sm" @click="detailsModalOpen = false"></div>
        
        <div class="relative bg-white rounded-xl shadow-2xl w-full max-w-4xl h-[80vh] flex overflow-hidden">
            <!-- Left: Image Preview -->
            <div class="w-2/3 bg-slate-950 flex flex-col items-center justify-center p-4">
                <img :src="'/media/' + targetFilename" class="max-w-full max-h-full object-contain shadow-lg">
                <p class="text-slate-500 text-xs font-mono mt-4" x-text="targetFilename"></p>
            </div>

            <!-- Right: Form -->
            <div class="w-1/3 bg-white p-6 flex flex-col">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-bold text-lg text-slate-800">Edit Details</h3>
                    <button @click="detailsModalOpen = false"><i class="fas fa-times text-slate-400"></i></button>
                </div>

                <!-- Registration Status -->
                <div class="mb-6 px-3 py-2 rounded text-xs font-bold uppercase flex items-center gap-2"
                     :class="targetId ? 'bg-green-100 text-green-700' : 'bg-slate-100 text-slate-600 border border-slate-200'">
                    <i class="fas" :class="targetId ? 'fa-check-circle' : 'fa-exclamation-circle'"></i>
                    <span x-text="targetId ? 'Registered in Database' : 'Unregistered File'"></span>
                </div>

                <div class="space-y-4 flex-1 overflow-y-auto">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Title</label>
                        <input type="text" x-model="form.title" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm outline-none focus:border-anita-500">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Description</label>
                        <textarea x-model="form.description" rows="3" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm outline-none focus:border-anita-500"></textarea>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Public Link</label>
                        <div class="flex gap-2">
                            <input type="text" x-model="form.link" readonly class="w-full bg-slate-50 px-3 py-2 border border-slate-200 rounded-lg text-xs text-slate-500">
                            <button @click="copyLink" class="px-3 bg-anita-100 text-anita-600 rounded-lg hover:bg-anita-200"><i class="fas fa-copy"></i></button>
                        </div>
                    </div>
                </div>

                <div class="mt-4 pt-4 border-t border-slate-100 space-y-2">
                    <button @click="saveDetails" class="w-full py-2 bg-anita-600 hover:bg-anita-700 text-white font-bold rounded-lg transition">
                        <span x-text="targetId ? 'Update Metadata' : 'Register File'"></span>
                    </button>
                    <button @click="deleteMedia" class="w-full py-2 text-red-500 hover:bg-red-50 font-bold rounded-lg text-sm transition">
                        Delete Permanently
                    </button>
                </div>
            </div>
        </div>
    </div>

</div>