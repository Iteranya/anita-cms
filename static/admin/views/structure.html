<div x-data="structureManager" class="flex flex-col h-full bg-slate-50">

    <!-- TOP NAV / HEADER -->
    <header class="bg-white border-b border-slate-200 sticky top-0 z-30 px-6 py-4 flex items-center justify-between shadow-sm">
        <div class="flex items-center gap-4">
            <div class="bg-indigo-600 text-white w-10 h-10 rounded-lg flex items-center justify-center shadow-indigo-200 shadow-md">
                <i class="fas fa-sitemap text-lg"></i>
            </div>
            <div>
                <h1 class="text-xl font-bold text-slate-800 leading-tight">Pages & Structure</h1>
                <p class="text-xs text-slate-500 font-medium">Manage site hierarchy and content</p>
            </div>
        </div>

        <div class="flex items-center gap-3">
            <!-- Add Group Button -->
            <div class="relative" x-data="{ open: false }">
                <button @click="open = !open" @click.outside="open = false" class="px-4 py-2 text-sm font-bold text-slate-600 hover:bg-slate-100 rounded-lg border border-transparent hover:border-slate-200 transition">
                    <i class="fas fa-folder-plus mr-2"></i> New Group
                </button>
                <!-- Inline Dropdown for New Group -->
                <div x-show="open" class="absolute top-full right-0 mt-2 w-64 bg-white rounded-xl shadow-xl border border-slate-100 p-3 z-50" x-transition>
                    <p class="text-xs font-bold text-slate-400 uppercase mb-2">Group Name</p>
                    <input type="text" x-model="newGroupName" @keydown.enter="addNewGroup(); open=false" placeholder="e.g. Portfolio" class="w-full form-input text-sm mb-2">
                    <button @click="addNewGroup(); open=false" class="w-full bg-slate-800 text-white text-xs font-bold py-2 rounded-lg hover:bg-slate-700">Create Folder</button>
                </div>
            </div>

            <!-- Add Page Button -->
            <button @click="openCreate()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2 rounded-lg shadow-lg shadow-indigo-200 font-bold text-sm flex items-center transition transform active:scale-95">
                <i class="fas fa-plus mr-2"></i> Create Page
            </button>
        </div>
    </header>

    <!-- CONTENT AREA -->
    <main class="flex-1 overflow-y-auto p-6 custom-scrollbar relative">
        
        <!-- Loading State -->
        <div x-show="isLoading" class="absolute inset-0 bg-white/80 z-20 flex items-center justify-center backdrop-blur-sm">
            <div class="flex flex-col items-center">
                <i class="fas fa-circle-notch fa-spin text-4xl text-indigo-500 mb-3"></i>
                <span class="text-slate-500 font-bold text-sm">Loading structure...</span>
            </div>
        </div>

        <div class="max-w-7xl mx-auto space-y-8 pb-20">

            <!-- LOOP: GROUPS -->
            <template x-for="[categoryName, pagesInCategory] in Object.entries(pageTree)" :key="categoryName">
                <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden transition-all duration-300"
                     :class="openGroups.includes(categoryName) ? 'pb-4' : ''">
                    
                    <!-- Group Header -->
                    <div @click="toggleGroup(categoryName)" 
                         class="px-6 py-4 bg-slate-50/50 border-b border-slate-100 flex items-center justify-between cursor-pointer hover:bg-slate-50 transition select-none group">
                        
                        <div class="flex items-center gap-3">
                            <i class="fas fa-chevron-right text-slate-400 transition-transform duration-200 text-xs"
                               :class="openGroups.includes(categoryName) ? 'rotate-90' : ''"></i>
                            
                            <div class="w-8 h-8 rounded-full bg-white border border-slate-200 flex items-center justify-center text-slate-500 shadow-sm">
                                <i class="fas" :class="categoryName === 'uncategorized' ? 'fa-layer-group' : 'fa-folder'"></i>
                            </div>
                            
                            <div>
                                <h3 class="font-bold text-slate-700 capitalize text-lg" x-text="categoryName === 'uncategorized' ? 'General Pages' : categoryName"></h3>
                                <p class="text-xs text-slate-400 font-mono" x-text="`${pagesInCategory.length} pages`"></p>
                            </div>
                        </div>

                        <!-- Header Actions (Only visible on hover) -->
                        <div class="opacity-0 group-hover:opacity-100 transition-opacity">
                             <!-- You could add folder settings here -->
                        </div>
                    </div>

                    <!-- Group Body (Collapsible) -->
                    <div x-show="openGroups.includes(categoryName)" 
                         x-collapse 
                         class="bg-slate-50/30">
                        
                        <!-- 
                            SORTABLE CONTAINER 
                            Critical Fix: Added min-h and specific data attributes
                        -->
                        <div x-sort="handlePageDrop($item, $position, categoryName)" 
     x-sort:group="pages" 
     class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 p-6 min-h-[150px] relative">
    
    <!-- PAGE CARDS -->
    <template x-for="page in pagesInCategory" :key="page.slug">
        <!-- Added x-sort:item="page.slug" -->
        <div x-sort:item="page.slug"
             class="group relative bg-white rounded-xl p-4 border border-slate-200 shadow-sm hover:shadow-md hover:border-indigo-300 transition-all cursor-move flex flex-col h-full z-10">
            
            <!-- Card Header -->
            <div class="flex items-start justify-between mb-2">
                <div class="flex items-center gap-2">
                    <span class="w-6 h-6 rounded flex items-center justify-center text-[10px] font-bold uppercase border"
                          :class="page.type === 'html' ? 'bg-orange-50 text-orange-600 border-orange-100' : 'bg-blue-50 text-blue-600 border-blue-100'">
                        <i class="fas" :class="page.type === 'html' ? 'fa-code' : 'fa-file-alt'"></i>
                    </span>
                    <template x-if="page.tags.includes('sys:home')">
                        <span class="text-[10px] bg-indigo-100 text-indigo-700 px-1.5 py-0.5 rounded font-bold">Home</span>
                    </template>
                </div>
                
                <!-- Hover Menu (Prevent Drag on Click) -->
                <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                    <button @mousedown.stop @click.stop="openEdit(page)" class="w-7 h-7 flex items-center justify-center rounded bg-slate-100 text-slate-500 hover:text-indigo-600 hover:bg-indigo-50 transition">
                        <i class="fas fa-cog text-xs"></i>
                    </button>
                    <button @mousedown.stop @click.stop="confirmDelete(page.slug)" class="w-7 h-7 flex items-center justify-center rounded bg-slate-100 text-slate-500 hover:text-red-600 hover:bg-red-50 transition">
                        <i class="fas fa-trash-alt text-xs"></i>
                    </button>
                </div>
            </div>

            <!-- Content -->
            <div class="flex-1 pointer-events-none"> <!-- content shouldn't capture drag events -->
                <h4 class="font-bold text-slate-800 text-base mb-1 line-clamp-1" x-text="page.title"></h4>
                <div class="flex items-center text-xs text-slate-400 font-mono bg-slate-50 rounded px-2 py-1 w-fit max-w-full overflow-hidden">
                    <span class="truncate" x-text="'/' + (categoryName !== 'uncategorized' ? categoryName + '/' : '') + page.slug"></span>
                </div>
            </div>

            <!-- Footer -->
            <div class="mt-4 pt-3 border-t border-slate-100 flex justify-between items-center">
                <div class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">
                    <span x-text="page.type"></span>
                </div>
                <!-- Link needs mousedown.stop so you can click it without dragging -->
                <a @mousedown.stop :href="`/${page.type === 'markdown' ? 'asta' : 'aina'}/?slug=${page.slug}`" 
                   class="text-xs font-bold text-indigo-600 hover:text-indigo-800 flex items-center gap-1 group/link cursor-pointer">
                    Edit <i class="fas fa-arrow-right transform group-hover/link:translate-x-1 transition"></i>
                </a>
            </div>

        </div>
    </template>

                            <!-- EMPTY STATE DROP ZONE -->
                            <!-- This ensures you can drag into an empty folder -->
                            <div x-show="pagesInCategory.length === 0" 
                                 class="col-span-1 md:col-span-2 lg:col-span-3 border-2 border-dashed border-slate-200 rounded-xl p-8 flex flex-col items-center justify-center text-slate-400 bg-slate-50/50">
                                <i class="fas fa-folder-open text-3xl mb-2 text-slate-300"></i>
                                <span class="text-sm font-medium">Empty Folder</span>
                                <span class="text-xs">Drag pages here</span>
                            </div>

                        </div>
                    </div>
                </div>
            </template>
            
            <!-- Guide Footer -->
            <div class="text-center py-8">
                <p class="text-slate-400 text-sm">Tip: Drag and drop cards between folders to change their category URL.</p>
            </div>

        </div>
    </main>

    <!-- 
        MODALS (CREATE, EDIT, DELETE) 
        Keep your existing modals here. 
        Ensure x-model="modalOpen" and x-model="deleteModalOpen" match the logic above.
    -->
    
    <!-- CREATE/EDIT MODAL -->
    <div x-show="modalOpen" class="fixed inset-0 z-50 flex items-center justify-center px-4" x-cloak>
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" @click="modalOpen = false" x-transition:enter="ease-out duration-200" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"></div>
        
        <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] flex flex-col border border-slate-100" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100">
            
            <!-- Header -->
            <div class="flex justify-between items-center px-6 py-4 border-b border-slate-100 bg-slate-50/70 rounded-t-2xl">
                <h3 class="text-xl font-bold text-slate-800" x-text="mode === 'create' ? 'Create New Page' : 'Edit Page Settings'"></h3>
                <button @click="modalOpen = false" class="text-slate-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
            </div>

            <!-- Tabs Navigation -->
            <div class="px-6 border-b border-slate-200 bg-white">
                <nav class="flex space-x-6 -mb-px">
                    <button @click="activeTab = 'general'" :class="{ 'border-indigo-500 text-indigo-600 font-bold': activeTab === 'general', 'border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300': activeTab !== 'general' }" class="whitespace-nowrap py-3 px-1 border-b-2 text-sm transition-colors">General</button>
                    <button @click="activeTab = 'content'" :class="{ 'border-indigo-500 text-indigo-600 font-bold': activeTab === 'content', 'border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300': activeTab !== 'content' }" class="whitespace-nowrap py-3 px-1 border-b-2 text-sm transition-colors">Content</button>
                    <button @click="activeTab = 'settings'" :class="{ 'border-indigo-500 text-indigo-600 font-bold': activeTab === 'settings', 'border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300': activeTab !== 'settings' }" class="whitespace-nowrap py-3 px-1 border-b-2 text-sm transition-colors">Permissions</button>
                </nav>
            </div>

            <!-- Body (Tab Content) -->
            <div class="flex-1 overflow-y-auto p-6 custom-scrollbar space-y-6">
                
                <!-- TAB 1: General -->
                <div x-show="activeTab === 'general'" class="space-y-6 animate-fade-in-fast">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-5">
                        <div class="col-span-1 sm:col-span-2">
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Page Title</label>
                            <input type="text" x-model="form.title" @input="handleTitleInput" class="w-full form-input font-bold text-lg">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">URL Slug</label>
                            <input type="text" x-model="form.slug" :disabled="mode === 'edit'" class="w-full form-input disabled:bg-slate-100 disabled:text-slate-500 font-mono text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Page Category / Group</label>
                            <input type="text" x-model="form.category" @input="handleCategoryInput" placeholder="e.g., blog, projects" class="w-full form-input font-mono text-sm">
                        </div>
                    </div>
                    <div class="relative py-2">
                        <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-slate-200"></div></div>
                        <div class="relative flex justify-center"><span class="px-3 bg-white text-xs font-bold text-slate-400 uppercase tracking-wider">Page Status</span></div>
                    </div>
                    <div class="space-y-4">
                        <label class="flex items-center p-4 bg-slate-50 border border-slate-200 rounded-xl hover:bg-slate-100/70 transition cursor-pointer">
                            <input type="checkbox" x-model="form.isPublic" class="sr-only peer">
                            <div class="w-10 h-6 bg-slate-300 rounded-full peer-checked:bg-green-500 transition-colors relative">
                                <div class="absolute top-1 left-1 w-4 h-4 bg-white rounded-full transition-transform transform peer-checked:translate-x-4"></div>
                            </div>
                            <div class="ml-4">
                                <p class="font-bold text-slate-700">Public Access</p>
                                <p class="text-xs text-slate-500">Allows anyone to view this page via its URL.</p>
                            </div>
                        </label>
                        <label class="flex items-center p-4 bg-slate-50 border border-slate-200 rounded-xl hover:bg-slate-100/70 transition cursor-pointer">
                            <input type="checkbox" x-model="form.isTemplate" class="sr-only peer">
                            <div class="w-10 h-6 bg-slate-300 rounded-full peer-checked:bg-green-500 transition-colors relative">
                                <div class="absolute top-1 left-1 w-4 h-4 bg-white rounded-full transition-transform transform peer-checked:translate-x-4"></div>
                            </div>
                            <div class="ml-4">
                                <p class="font-bold text-slate-700">Template</p>
                                <p class="text-xs text-slate-500">Mark This Page As Template.</p>
                            </div>
                        </label>
                        <label class="flex items-center p-4 bg-slate-50 border border-slate-200 rounded-xl hover:bg-slate-100/70 transition cursor-pointer">
                            <input type="checkbox" x-model="form.isHome" class="sr-only peer">
                            <div class="w-10 h-6 bg-slate-300 rounded-full peer-checked:bg-blue-500 transition-colors relative">
                                <div class="absolute top-1 left-1 w-4 h-4 bg-white rounded-full transition-transform transform peer-checked:translate-x-4"></div>
                            </div>
                            <div class="ml-4">
                                <p class="font-bold text-slate-700">Set as Site Homepage</p>
                                <p class="text-xs text-slate-500">This page will be served at your site's main `/` URL.</p>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- TAB 2: Permissions and Security -->
                <div x-show="activeTab === 'settings'" class="space-y-4 animate-fade-in-fast">
                    <h4 class="font-bold text-slate-800">Role-Based Access Control</h4>
                    <div class="overflow-x-auto bg-slate-50 border border-slate-200 rounded-lg">
                        <table class="min-w-full text-sm">
                            <thead class="bg-slate-100 text-slate-500">
                                <tr>
                                    <th class="text-left font-bold uppercase p-3">Role</th>
                                    <th class="text-center font-bold uppercase p-3">Create</th>
                                    <th class="text-center font-bold uppercase p-3">Read</th>
                                    <th class="text-center font-bold uppercase p-3">Update</th>
                                    <th class="text-center font-bold uppercase p-3">Delete</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-200">
                                <template x-for="role in roles" :key="role">
                                    <tr>
                                        <td class="p-3 font-mono font-bold text-slate-700 capitalize" x-text="role"></td>
                                        <!-- Note: Added checks to ensure form.permissions[role] exists -->
                                        <td class="p-3 text-center"><input type="checkbox" x-if="form.permissions[role]" x-model="form.permissions[role].create" class="form-checkbox"></td>
                                        <td class="p-3 text-center"><input type="checkbox" x-if="form.permissions[role]" x-model="form.permissions[role].read" class="form-checkbox"></td>
                                        <td class="p-3 text-center"><input type="checkbox" x-if="form.permissions[role]" x-model="form.permissions[role].update" class="form-checkbox"></td>
                                        <td class="p-3 text-center"><input type="checkbox" x-if="form.permissions[role]" x-model="form.permissions[role].delete" class="form-checkbox"></td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="px-6 py-4 bg-slate-50/70 border-t border-slate-100 flex justify-end gap-3 rounded-b-2xl">
                <button @click="modalOpen = false" class="px-4 py-2 text-sm font-bold text-slate-500 hover:text-slate-700 bg-white border border-slate-200 rounded-lg shadow-sm">Cancel</button>
                <button @click="save" :disabled="isSaving" class="px-6 py-2 bg-slate-900 hover:bg-slate-800 text-white text-sm font-bold rounded-lg shadow-lg flex items-center justify-center min-w-[120px] disabled:opacity-50">
                    <span x-show="!isSaving">Save Changes</span>
                    <i x-show="isSaving" class="fas fa-circle-notch fa-spin"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- DELETE MODAL -->
    <div x-show="deleteModalOpen" class="fixed inset-0 z-50 flex items-center justify-center px-4" x-cloak>
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" @click="deleteModalOpen = false"></div>
        <div class="relative bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 text-center transform transition-all" x-transition:enter="ease-out duration-200" x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100">
            <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-exclamation-triangle text-red-500 text-2xl"></i>
            </div>
            <h3 class="text-lg font-bold text-slate-800 mb-2">Delete Page?</h3>
            <p class="text-sm text-slate-500 mb-6">Are you sure you want to delete <span x-text="targetSlug" class="font-mono font-bold text-slate-700"></span>?</p>
            <div class="flex justify-center gap-3">
                <button @click="deleteModalOpen = false" class="px-4 py-2 text-sm font-bold text-slate-600 bg-slate-100 rounded-lg hover:bg-slate-200">Cancel</button>
                <button @click="doDelete" class="px-4 py-2 text-sm font-bold text-white bg-red-500 rounded-lg hover:bg-red-600 shadow-lg">Yes, Delete</button>
            </div>
        </div>
    </div>

</div>