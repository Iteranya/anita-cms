<!-- Custom Styles for Toggle Switch -->
<style>
    .toggle-checkbox:checked { right: 0; border-color: #0ea5e9; }
    .toggle-checkbox:checked + .toggle-label { background-color: #0ea5e9; }
    .toggle-checkbox { right: calc(100% - 1.5rem); }
</style>

<div x-data="userManager" class="flex flex-col h-full bg-slate-50">
    
    <!-- HEADER -->
    <header class="bg-white border-b border-slate-200 flex flex-col shrink-0 z-20 shadow-sm">
        <!-- Top Title Bar -->
        <div class="h-16 flex items-center justify-between px-8">
            <h1 class="text-xl font-bold text-slate-800">System Management</h1>
            
            <!-- Global Actions -->
            <div>
                <!-- Shows "Add Member" only when on Users tab -->
                <button x-show="view === 'users'" @click="openCreateUser" class="bg-slate-900 hover:bg-slate-800 text-white px-4 py-2 rounded-lg text-sm font-bold transition shadow-lg flex items-center gap-2">
                    <i class="fas fa-user-plus text-xs"></i> <span>Add Member</span>
                </button>
                
                <!-- Shows "Add Role" only when on Roles tab -->
                <button x-show="view === 'roles'" @click="createNewRole" class="bg-slate-900 hover:bg-slate-800 text-white px-4 py-2 rounded-lg text-sm font-bold transition shadow-lg flex items-center gap-2">
                    <i class="fas fa-plus text-xs"></i> <span>Create Role</span>
                </button>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="px-8 flex items-center gap-8 -mb-px">
            <button @click="view = 'users'" 
                :class="view === 'users' ? 'border-anita-600 text-anita-600' : 'border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300'"
                class="pb-3 border-b-2 text-sm font-bold transition-colors flex items-center gap-2">
                <i class="fas fa-users"></i> Users
            </button>
            <button @click="view = 'roles'; if(!selectedRole && roles.length > 0) selectRole(roles[0])" 
                :class="view === 'roles' ? 'border-anita-600 text-anita-600' : 'border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300'"
                class="pb-3 border-b-2 text-sm font-bold transition-colors flex items-center gap-2">
                <i class="fas fa-shield-alt"></i> Roles & Permissions
            </button>
        </div>
    </header>

    <!-- CONTENT BODY -->
    <div class="flex-1 overflow-hidden p-6 relative">
        
        <!-- Loading -->
        <div x-show="isLoading" class="absolute inset-0 flex items-center justify-center bg-slate-50 z-50">
             <i class="fas fa-circle-notch fa-spin text-3xl text-anita-500"></i>
        </div>

        <!-- ==================== USERS VIEW ==================== -->
        <div x-show="view === 'users'" class="h-full flex flex-col max-w-6xl mx-auto" x-cloak>
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 flex-1 flex flex-col overflow-hidden">
                <div class="flex-1 overflow-y-auto custom-scrollbar">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-slate-50 sticky top-0 z-10 shadow-sm">
                            <tr class="text-xs font-bold text-slate-400 uppercase tracking-wider">
                                <th class="py-3 px-6 pl-8">User</th>
                                <th class="py-3 px-6">Role</th>
                                <th class="py-3 px-6 text-right pr-8">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100">
                            <template x-for="user in users" :key="user.username">
                                <tr class="group hover:bg-slate-50/80 transition-colors">
                                    <td class="py-3 px-6 pl-8">
                                        <div class="flex items-center">
                                            <!-- Avatar -->
                                            <div class="w-10 h-10 rounded-full bg-slate-200 flex items-center justify-center text-slate-500 mr-3 overflow-hidden border border-slate-200">
                                                <template x-if="user.pfp_url"><img :src="user.pfp_url" class="w-full h-full object-cover"></template>
                                                <template x-if="!user.pfp_url"><i class="fas fa-user"></i></template>
                                            </div>
                                            <div>
                                                <div class="font-bold text-slate-800" x-text="user.display_name || user.username"></div>
                                                <div class="text-xs text-slate-400 font-mono" x-text="'@' + user.username"></div>
                                            </div>
                                            <span x-show="user.disabled" class="ml-2 px-1.5 py-0.5 rounded text-[10px] font-bold bg-red-100 text-red-600 uppercase border border-red-200">Disabled</span>
                                        </div>
                                    </td>
                                    <td class="py-3 px-6">
                                        <span class="inline-flex items-center px-2 py-1 rounded text-xs font-bold bg-slate-100 text-slate-600 border border-slate-200">
                                            <span class="w-2 h-2 rounded-full bg-anita-500 mr-1.5"></span>
                                            <span x-text="user.role"></span>
                                        </span>
                                    </td>
                                    <td class="py-3 px-6 text-right pr-8">
                                        <div class="flex items-center justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                            <button @click="openEditUser(user)" class="w-8 h-8 flex items-center justify-center rounded bg-slate-100 hover:bg-white hover:shadow-sm border border-transparent hover:border-slate-200 text-slate-600 transition"><i class="fas fa-pen text-xs"></i></button>
                                            <button @click="openPasswordModal(user)" class="w-8 h-8 flex items-center justify-center rounded bg-slate-100 hover:bg-white hover:shadow-sm border border-transparent hover:border-slate-200 text-slate-600 transition"><i class="fas fa-key text-xs"></i></button>
                                            <button @click="confirmDelete('user', user.username)" class="w-8 h-8 flex items-center justify-center rounded bg-red-50 hover:bg-red-100 text-red-600 transition"><i class="fas fa-trash text-xs"></i></button>
                                        </div>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ==================== ROLES VIEW ==================== -->
        <div x-show="view === 'roles'" class="h-full flex gap-6 max-w-7xl mx-auto" x-cloak>
            
            <!-- Left: Roles List Sidebar -->
            <div class="w-64 flex flex-col">
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden flex flex-col h-full">
                    <div class="p-3 border-b border-slate-100 bg-slate-50/50">
                        <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">Roles</span>
                    </div>
                    <div class="flex-1 overflow-y-auto p-2 space-y-1 custom-scrollbar">
                        <template x-for="role in roles" :key="role.role_name">
                            <div @click="selectRole(role)" 
                                 :class="selectedRole && selectedRole.role_name === role.role_name ? 'bg-anita-50 border-anita-200 text-anita-700 shadow-sm' : 'border-transparent text-slate-500 hover:bg-slate-50 hover:text-slate-700'"
                                 class="px-3 py-2.5 rounded-lg border cursor-pointer text-sm font-bold flex items-center justify-between group transition-all">
                                <div class="flex items-center gap-2 truncate">
                                    <div class="w-2 h-2 rounded-full bg-slate-300" :class="selectedRole && selectedRole.role_name === role.role_name ? 'bg-anita-500' : ''"></div>
                                    <span x-text="role.role_name"></span>
                                </div>
                                <button @click.stop="confirmDelete('role', role.role_name)" class="text-xs text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition p-1"><i class="fas fa-trash"></i></button>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <!-- Right: Role Editor -->
            <div class="flex-1 flex flex-col h-full">
                <!-- Editor Container -->
                <div x-show="selectedRole" class="bg-white rounded-xl shadow-sm border border-slate-200 flex flex-col h-full relative overflow-hidden">
                    
                    <!-- Editor Header -->
                    <div class="h-16 border-b border-slate-100 flex items-center justify-between px-8 bg-white z-10 shrink-0">
                        <div class="flex-1 mr-4">
                            <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">Role Name</label>
                            <input type="text" x-model="roleForm.role_name" class="w-full max-w-sm px-0 py-0 text-xl font-bold text-slate-800 border-none focus:ring-0 placeholder-slate-300 bg-transparent" placeholder="Enter Role Name">
                        </div>
                        <button id="save-role-btn" @click="saveRole" class="bg-anita-600 hover:bg-anita-700 text-white px-6 py-2.5 rounded-lg shadow-md font-bold text-sm transition transform hover:-translate-y-0.5">
                            <i class="fas fa-save mr-2"></i>Save Changes
                        </button>
                    </div>
                    
                    <!-- Permissions Scroll Area -->
                    <div class="flex-1 overflow-y-auto p-8 bg-slate-50/50 custom-scrollbar">
                        <template x-for="cat in permCategories" :key="cat.name">
                            <div class="mb-8 bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                                <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4 border-b border-slate-100 pb-2" x-text="cat.name"></h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-12 gap-y-6">
                                    <template x-for="perm in cat.perms" :key="perm.key">
                                        <div class="flex items-start justify-between">
                                            <div class="mr-4">
                                                <div class="text-sm font-bold text-slate-700" x-text="perm.label"></div>
                                                <div class="text-xs text-slate-400 mt-0.5 leading-relaxed" x-text="perm.desc"></div>
                                            </div>
                                            
                                            <!-- Custom Toggle Switch -->
                                            <div class="relative inline-block w-11 h-6 align-middle select-none shrink-0 mt-1">
                                                <input type="checkbox" :id="perm.key" 
                                                       class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-200 transition-all duration-300 top-0.5 z-10" 
                                                       :checked="roleForm.permissions.includes(perm.key)"
                                                       @change="togglePermission(perm.key)"/>
                                                <label :for="perm.key" class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-200 cursor-pointer transition-colors duration-300"></label>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Empty State -->
                <div x-show="!selectedRole" class="flex-1 bg-white rounded-xl shadow-sm border border-slate-200 flex flex-col items-center justify-center text-slate-400">
                    <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mb-4 text-2xl">
                         <i class="fas fa-shield-alt"></i>
                    </div>
                    <p class="font-bold">Select a role to edit permissions</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ================= MODALS ================= -->

    <!-- User Create/Edit Modal -->
    <div x-show="userModalOpen" class="fixed inset-0 z-50 flex items-center justify-center px-4" x-cloak>
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" @click="userModalOpen = false"></div>
        <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 animate-fade-in border border-slate-100">
            <h3 class="text-xl font-bold text-slate-800 mb-6" x-text="isEditingUser ? 'Edit User' : 'Create User'"></h3>
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Username</label>
                        <input type="text" x-model="userForm.username" :disabled="isEditingUser" class="w-full px-3 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-anita-500 outline-none disabled:bg-slate-100 font-mono text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Display Name</label>
                        <input type="text" x-model="userForm.display_name" class="w-full px-3 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-anita-500 outline-none">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Role</label>
                    <div class="relative">
                        <select x-model="userForm.role" class="w-full px-3 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-anita-500 outline-none bg-white appearance-none">
                            <template x-for="r in roles" :key="r.role_name">
                                <option :value="r.role_name" x-text="r.role_name"></option>
                            </template>
                        </select>
                        <i class="fas fa-chevron-down absolute right-3 top-3 text-slate-400 text-xs pointer-events-none"></i>
                    </div>
                </div>
                <div x-show="!isEditingUser">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Password</label>
                    <input type="password" x-model="userForm.password" class="w-full px-3 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-anita-500 outline-none">
                </div>
                <div x-show="isEditingUser" class="flex items-center gap-2 pt-2">
                    <input type="checkbox" id="userDisabled" x-model="userForm.disabled" class="w-4 h-4 text-anita-600 rounded">
                    <label for="userDisabled" class="text-sm font-bold text-slate-600">Disable Account</label>
                </div>
            </div>
            <div class="mt-8 flex justify-end gap-3">
                <button @click="userModalOpen = false" class="px-4 py-2 text-sm font-bold text-slate-500 bg-white border border-slate-200 rounded-lg hover:bg-slate-50">Cancel</button>
                <button @click="saveUser" class="px-6 py-2 text-sm font-bold text-white bg-slate-900 rounded-lg hover:bg-slate-800 shadow-lg">Save User</button>
            </div>
        </div>
    </div>

    <!-- Password Modal -->
    <div x-show="passwordModalOpen" class="fixed inset-0 z-50 flex items-center justify-center px-4" x-cloak>
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" @click="passwordModalOpen = false"></div>
        <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 animate-fade-in border border-slate-100">
            <h3 class="text-lg font-bold text-slate-800 mb-2">Reset Password</h3>
            <p class="text-sm text-slate-500 mb-6">New password for <span class="font-bold text-slate-700 font-mono" x-text="passwordForm.username"></span></p>
            <input type="password" x-model="passwordForm.new_password" placeholder="New Password" class="w-full px-3 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-anita-500 outline-none mb-6">
            <div class="flex justify-end gap-3">
                <button @click="passwordModalOpen = false" class="px-4 py-2 text-sm font-bold text-slate-500 bg-white border border-slate-200 rounded-lg hover:bg-slate-50">Cancel</button>
                <button @click="changePassword" class="px-6 py-2 text-sm font-bold text-white bg-slate-900 rounded-lg hover:bg-slate-800 shadow-lg">Update</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation -->
    <div x-show="deleteModalOpen" class="fixed inset-0 z-50 flex items-center justify-center px-4" x-cloak>
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" @click="deleteModalOpen = false"></div>
        <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 text-center animate-fade-in border border-slate-100">
            <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4"><i class="fas fa-exclamation-triangle text-red-500 text-2xl"></i></div>
            <h3 class="text-lg font-bold text-slate-800 mb-2">Are you sure?</h3>
            <p class="text-sm text-slate-500 mb-6">Delete <span x-text="deleteTarget.id" class="font-mono font-bold text-slate-700"></span>? This cannot be undone.</p>
            <div class="flex justify-center gap-3">
                <button @click="deleteModalOpen = false" class="px-4 py-2 text-sm font-bold text-slate-600 bg-slate-100 rounded-lg hover:bg-slate-200">Cancel</button>
                <button @click="doDelete" class="px-4 py-2 text-sm font-bold text-white bg-red-500 rounded-lg hover:bg-red-600 shadow-lg">Yes, Delete</button>
            </div>
        </div>
    </div>
</div>