<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Submissions Manager</title>
    
    <!-- Dependencies (Shared) -->
    <script src="/static/hikarin/lib/tailwind.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Core JS -->
    <script defer src="https://unpkg.com/htmx.org@1.9.10"></script>    

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Nunito', 'sans-serif'] },
                    colors: {
                        anita: { 50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7', 900: '#0c4a6e' }
                    }
                }
            }
        }
    </script>
    <style>
        [x-cloak] { display: none !important; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    </style>
</head>

<body class="bg-slate-50 text-slate-800 font-sans min-h-screen" x-data="submissionManager">

    <div class="max-w-7xl mx-auto p-6">
        
        <!-- Header -->
        <header class="mb-8 flex flex-col md:flex-row md:items-end justify-between gap-4">
            <div>
                <h1 class="text-3xl font-extrabold text-slate-900 mb-2">Submissions Manager</h1>
                <p class="text-sm text-slate-500">
                    Managing data for: <span class="font-mono font-bold text-anita-600 bg-anita-50 px-2 py-1 rounded" x-text="slug || '...'"></span>
                </p>
            </div>
            
            <div class="flex gap-3">
                <button @click="refresh" class="px-4 py-2 bg-white border border-slate-200 text-slate-600 font-bold rounded-lg shadow-sm hover:bg-slate-50 transition text-sm">
                    <i class="fas fa-sync-alt mr-2"></i> Refresh
                </button>
                <button @click="downloadCSV" class="px-4 py-2 bg-slate-900 text-white font-bold rounded-lg shadow-lg hover:bg-slate-800 transition text-sm flex items-center">
                    <i class="fas fa-file-csv mr-2"></i> Download CSV
                </button>
            </div>
        </header>

        <!-- Main Card -->
        <main class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden min-h-[60vh] flex flex-col">
            
            <!-- Loading State -->
            <div x-show="isLoading" class="flex-1 flex items-center justify-center">
                <i class="fas fa-circle-notch fa-spin text-4xl text-anita-400"></i>
            </div>

            <!-- Error / Empty State -->
            <div x-show="!isLoading && submissions.length === 0" class="flex-1 flex flex-col items-center justify-center text-slate-400 py-20" x-cloak>
                <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mb-4 text-2xl">
                    <i class="fas fa-inbox"></i>
                </div>
                <p>No submissions found for this collection.</p>
            </div>

            <!-- Table -->
            <div x-show="!isLoading && submissions.length > 0" class="overflow-x-auto" x-cloak>
                <table class="w-full text-left text-sm whitespace-nowrap">
                    <thead class="bg-slate-50 border-b border-slate-200 text-xs font-bold text-slate-500 uppercase">
                        <tr>
                            <th class="px-6 py-4 w-20">ID</th>
                            <th class="px-6 py-4 w-40">Date</th>
                            
                            <!-- Dynamic Headers -->
                            <template x-for="h in headers" :key="h">
                                <th class="px-6 py-4" x-text="h"></th>
                            </template>
                            
                            <th class="px-6 py-4 text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100">
                        <template x-for="sub in submissions" :key="sub.id">
                            <tr class="hover:bg-slate-50 transition group">
                                <td class="px-6 py-4 font-mono text-xs text-slate-400" x-text="'#' + sub.id"></td>
                                <td class="px-6 py-4 text-slate-500" x-text="new Date(sub.created).toLocaleDateString()"></td>
                                
                                <!-- Dynamic Cells -->
                                <template x-for="h in headers" :key="h">
                                    <td class="px-6 py-4 max-w-xs truncate text-slate-700" x-text="sub.data[h] || '-'"></td>
                                </template>

                                <td class="px-6 py-4 text-right">
                                    <div class="flex items-center justify-end gap-2 opacity-0 group-hover:opacity-100 transition">
                                        <button @click="openEdit(sub)" class="px-3 py-1 bg-anita-50 text-anita-700 rounded-md text-xs font-bold hover:bg-anita-100 transition">Edit</button>
                                        <button @click="deleteSubmission(sub.id)" class="px-3 py-1 bg-red-50 text-red-600 rounded-md text-xs font-bold hover:bg-red-100 transition">Delete</button>
                                    </div>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <!-- EDIT MODAL -->
    <div x-show="modalOpen" class="fixed inset-0 z-50 flex items-center justify-center px-4" x-cloak>
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" @click="modalOpen = false"></div>
        <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col overflow-hidden animate-float">
            
            <div class="px-6 py-4 bg-slate-50 border-b border-slate-200 flex justify-between items-center">
                <h3 class="font-bold text-lg text-slate-800">Edit Submission <span class="text-slate-400 font-mono text-sm ml-2" x-text="'#' + editId"></span></h3>
                <button @click="modalOpen = false"><i class="fas fa-times text-slate-400 hover:text-slate-600"></i></button>
            </div>

            <div class="p-6 overflow-y-auto space-y-5">
                <template x-for="f in fields" :key="f.name">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1" x-text="f.label || f.name"></label>
                        
                        <!-- Textarea -->
                        <template x-if="f.type === 'textarea'">
                            <textarea x-model="record[f.name]" rows="4" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-anita-500 outline-none"></textarea>
                        </template>

                        <!-- Standard Input -->
                        <template x-if="f.type !== 'textarea' && f.type !== 'checkbox'">
                            <input :type="f.type || 'text'" x-model="record[f.name]" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-anita-500 outline-none">
                        </template>

                        <!-- Checkbox -->
                        <template x-if="f.type === 'checkbox'">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" x-model="record[f.name]" class="w-4 h-4 text-anita-600 rounded">
                                <span class="text-sm font-bold text-slate-700">True</span>
                            </label>
                        </template>
                    </div>
                </template>
            </div>

            <div class="px-6 py-4 border-t border-slate-100 flex justify-end gap-3 bg-slate-50">
                <button @click="modalOpen = false" class="px-4 py-2 rounded-lg text-sm font-bold text-slate-500 bg-white border border-slate-200 hover:bg-slate-50">Cancel</button>
                <button @click="save" class="px-6 py-2 rounded-lg text-sm font-bold text-white bg-slate-900 hover:bg-slate-800 shadow-lg">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Notification Container (Hooks into Store) -->
    <div class="fixed bottom-6 right-6 z-50 flex flex-col gap-3 pointer-events-none">
        <template x-for="note in $store.notifications.items" :key="note.id">
            <div x-show="true" x-transition class="pointer-events-auto w-80 shadow-2xl rounded-xl bg-white flex overflow-hidden border border-slate-100">
                <div class="w-2" :class="{'bg-green-500': note.type==='success', 'bg-red-500': note.type==='error', 'bg-blue-500': note.type==='info'}"></div>
                <div class="p-3">
                    <h4 class="text-sm font-bold text-slate-800" x-text="note.title"></h4>
                    <p class="text-xs text-slate-500" x-text="note.message"></p>
                </div>
            </div>
        </template>
    </div>

    <script type="module" src="/static/admin/main.js"></script>

</body>
</html>