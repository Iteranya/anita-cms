<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anita Admin | Pages</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Dependencies -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    <script src="/static/hikarin/hikarin.js"></script>

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Nunito', 'sans-serif'] },
                    colors: {
                        anita: {
                            50: '#f0f9ff', 100: '#e0f2fe', 200: '#bae6fd', 300: '#7dd3fc',
                            400: '#38bdf8', 500: '#0ea5e9', 600: '#0284c7', 700: '#0369a1',
                        }
                    },
                    animation: { 'float': 'float 0.3s ease-out' },
                    keyframes: {
                        float: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } }
                    }
                }
            }
        }
    </script>

    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        [x-cloak] { display: none !important; }
    </style>
</head>

<body class="bg-slate-100 text-slate-800 font-sans h-screen overflow-hidden flex"
    x-data="{
        pages: [],
        search: '',
        
        // Modal State
        modalOpen: false,
        deleteModalOpen: false,
        targetSlug: '',
        mode: 'create',

        // Requests
        listReq: null,
        
        // Form Data
        form: {
            title: '',
            slug: '',
            description: '',
            thumb: '',
            type: 'markdown',
            tagInput: '',
            tags: [],
            customFields: [],
            content: '',
            markdown: '',
            html: ''
        },

        async init() {
            this.listReq = $api.pages.list();
            this.refreshList();
        },

        async refreshList() {
            try {
                await this.listReq.execute();
                if(this.listReq.isSuccess) this.pages = this.listReq.data;
            } catch(e) { console.error('Load failed', e); }
        },

        openCreate() {
            this.mode = 'create';
            this.resetForm();
            this.modalOpen = true;
        },

        openEdit(page) {
            this.mode = 'edit';
            this.targetSlug = page.slug;
            
            // Populate Form
            this.form.title = page.title;
            this.form.slug = page.slug;
            this.form.type = page.type || 'markdown';
            this.form.thumb = page.thumb || '';
            this.form.tags = page.tags ? [...page.tags] : [];
            this.form.content = page.content;
            this.form.markdown = page.markdown;
            this.form.html = page.html;
            
            this.form.customFields = [];
            this.form.description = '';
            if(page.custom) {
                this.form.description = page.custom.description || '';
                Object.entries(page.custom).forEach(([k, v]) => {
                    if(k !== 'description') this.form.customFields.push({k: k, v: v});
                });
            }
            this.modalOpen = true;
        },

        resetForm() {
            this.form = {
                title: '', slug: '', description: '', thumb: '',
                type: 'markdown', tagInput: '', tags: [], customFields: [],
                content: '', markdown: '', html: ''
            };
        },

        generateSlug() {
            if(this.mode === 'create') {
                this.form.slug = this.form.title.toLowerCase().replace(/[^\w\s-]/g, '').replace(/\s+/g, '-');
            }
        },

        addTag() {
            const val = this.form.tagInput.trim();
            if(val && !this.form.tags.includes(val)) this.form.tags.push(val);
            this.form.tagInput = '';
        },

        removeTag(index) { this.form.tags.splice(index, 1); },
        addCustomField() { this.form.customFields.push({k: '', v: ''}); },
        removeCustomField(index) { this.form.customFields.splice(index, 1); },

        async uploadThumbnail(e) {
            const files = e.target.files;
            if(files.length > 0) {
                const req = $api.media.upload();
                try {
                    await req.execute(files);
                    if(req.isSuccess && req.data.files.length > 0) {
                        this.form.thumb = '/media/' + req.data.files[0].saved_as;
                    }
                } catch(err) { alert('Upload failed'); }
            }
        },

        async savePage() {
            const customObj = { description: this.form.description };
            this.form.customFields.forEach(f => { if(f.k) customObj[f.k] = f.v; });

            const payload = {
                title: this.form.title,
                slug: this.form.slug,
                type: this.form.type,
                thumb: this.form.thumb,
                tags: this.form.tags,
                custom: customObj,
                content: this.form.content,
                markdown: this.form.markdown,
                html: this.form.html
            };

            try {
                if(this.mode === 'create') await $api.pages.create().execute(payload);
                else await $api.pages.update().execute(this.targetSlug, payload);
                this.modalOpen = false;
                this.refreshList();
            } catch(e) { alert('Error: ' + (e.message || 'Unknown error')); }
        },

        confirmDelete(slug) {
            this.targetSlug = slug;
            this.deleteModalOpen = true;
        },

        async doDelete() {
            try {
                await $api.pages.delete().execute(this.targetSlug);
                this.deleteModalOpen = false;
                this.refreshList();
            } catch(e) { alert('Delete failed'); }
        }
    }"
>
    <!-- LEFT SIDEBAR -->
    <aside class="w-64 bg-slate-900 text-white flex flex-col flex-shrink-0 z-20">
        <div class="h-16 flex items-center px-6 border-b border-slate-800 bg-slate-950">
            <img src="/media/anita.jpg" class="h-8 w-8 rounded-full border border-anita-500 mr-3" alt="Logo">
            <span class="font-bold text-lg tracking-wide">Anita CMS</span>
        </div>
        <nav class="flex-1 overflow-y-auto py-4 space-y-1 px-3">
            <a href="/admin/page/" class="flex items-center px-3 py-2.5 bg-anita-600 text-white rounded-lg shadow-lg shadow-anita-900/20 transition-colors group">
                <i class="fas fa-layer-group w-6 text-center text-lg"></i>
                <span class="ml-3 font-semibold">Pages</span>
            </a>
            <a href="/admin/forms/" class="flex items-center px-3 py-2.5 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition-colors group">
                <i class="fas fa-inbox w-6 text-center text-lg group-hover:text-anita-400"></i>
                <span class="ml-3 font-medium">Forms</span>
            </a>
            <a href="/admin/media/" class="flex items-center px-3 py-2.5 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition-colors group">
                <i class="fas fa-images w-6 text-center text-lg group-hover:text-purple-400"></i>
                <span class="ml-3 font-medium">Images</span>
            </a>
            <a href="/admin/files/" class="flex items-center px-3 py-2.5 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition-colors">
                <i class="fas fa-folder-open w-6 text-center text-lg"></i>
                <span class="ml-3 font-medium">Files</span>
            </a>
            <div class="pt-4 pb-2"><p class="px-3 text-xs font-bold text-slate-500 uppercase tracking-wider">System</p></div>
            <a href="/admin/config/" class="flex items-center px-3 py-2.5 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition-colors group">
                <i class="fas fa-robot w-6 text-center text-lg group-hover:text-gray-300"></i>
                <span class="ml-3 font-medium">AI Config</span>
            </a>
            <a href="/admin/users/" class="flex items-center px-3 py-2.5 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition-colors group">
                <i class="fas fa-users-cog w-6 text-center text-lg"></i>
                <span class="ml-3 font-semibold">Users & Roles</span>
            </a>
        </nav>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 flex flex-col min-w-0 overflow-hidden">
        <header class="bg-white border-b border-slate-200 h-16 flex items-center justify-between px-8 shadow-sm z-10">
            <h1 class="text-xl font-bold text-slate-800">Pages Manager</h1>
            <button @click="openCreate()" class="bg-slate-900 hover:bg-slate-800 text-white px-4 py-2 rounded-lg shadow-lg transition-all font-bold text-sm flex items-center">
                <i class="fas fa-plus mr-2"></i> New Page
            </button>
        </header>

        <div class="flex-1 overflow-y-auto p-8">
            <div class="mb-6 relative w-full sm:w-96">
                <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                <input type="text" x-model="search" placeholder="Search pages..." class="w-full pl-10 pr-4 py-2 bg-white border border-slate-200 rounded-xl focus:ring-2 focus:ring-anita-500 outline-none shadow-sm">
            </div>

            <div x-show="listReq && listReq.isLoading" class="flex justify-center items-center h-64">
                <i class="fas fa-circle-notch fa-spin text-4xl text-anita-400"></i>
            </div>

            <div x-show="!listReq || !listReq.isLoading" class="grid gap-4" x-cloak>
                <template x-for="page in pages.filter(p => p.title.toLowerCase().includes(search.toLowerCase()))" :key="page.slug">
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 hover:shadow-md transition flex items-center justify-between">
                        <div class="flex items-center gap-4 overflow-hidden">
                            <div class="w-10 h-10 rounded-lg flex items-center justify-center flex-shrink-0"
                                :class="page.type === 'markdown' ? 'bg-purple-100 text-purple-600' : 'bg-pink-100 text-pink-600'">
                                <i class="fas" :class="page.type === 'markdown' ? 'fa-pen-nib' : 'fa-code'"></i>
                            </div>
                            <div class="min-w-0">
                                <div class="flex items-center gap-2">
                                    <h4 class="font-bold text-slate-800 leading-none truncate" x-text="page.title"></h4>
                                    <span class="text-[10px] uppercase font-extrabold px-1.5 py-0.5 rounded border flex-shrink-0"
                                        :class="page.type === 'markdown' ? 'bg-purple-50 text-purple-700 border-purple-200' : 'bg-pink-50 text-pink-700 border-pink-200'"
                                        x-text="page.type === 'markdown' ? 'Markdown (Asta)' : 'HTML (Aina)'">
                                    </span>
                                </div>
                                <div class="flex flex-wrap items-center gap-x-3 gap-y-1 mt-1.5">
                                    <p class="text-xs text-slate-400 font-mono" x-text="'/' + page.slug"></p>
                                    <div class="flex flex-wrap gap-1">
                                        <template x-for="tag in (page.tags || [])">
                                            <span class="px-1.5 py-0.5 rounded text-[10px] font-bold bg-slate-100 text-slate-500 border border-slate-200" x-text="'#' + tag"></span>
                                        </template>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-2 ml-4 flex-shrink-0">
                            <button @click="openEdit(page)" class="w-8 h-8 rounded-full bg-slate-50 hover:bg-blue-50 text-slate-400 hover:text-blue-600 transition flex items-center justify-center"><i class="fas fa-cog text-xs"></i></button>
                            <a :href="`/${page.type === 'markdown' ? 'asta' : 'aina'}/?slug=${page.slug}`" class="w-8 h-8 rounded-full bg-slate-50 hover:bg-anita-50 text-slate-400 hover:text-anita-600 transition flex items-center justify-center"><i class="fas fa-edit text-xs"></i></a>
                            <button @click="confirmDelete(page.slug)" class="w-8 h-8 rounded-full bg-slate-50 hover:bg-red-50 text-slate-400 hover:text-red-600 transition flex items-center justify-center"><i class="fas fa-trash text-xs"></i></button>
                        </div>
                    </div>
                </template>
                <div x-show="pages.length === 0" class="text-center py-10 text-slate-400"><p>No pages found.</p></div>
            </div>
        </div>
    </main>

    <!-- CREATE/EDIT MODAL (Combined Tabs) -->
    <div x-show="modalOpen" class="fixed inset-0 z-50 flex items-center justify-center" x-cloak>
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" @click="modalOpen = false" 
             x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"></div>
        
        <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col border border-slate-100 animate-float">
            <!-- Header -->
            <div class="flex justify-between items-center px-6 py-4 border-b border-slate-100">
                <h3 class="text-xl font-bold text-slate-800" x-text="mode === 'create' ? 'Add New Page' : 'Edit Page'"></h3>
                <button @click="modalOpen = false" class="text-slate-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
            </div>

            <!-- Body (Combined Tabs) -->
            <div class="flex-1 overflow-y-auto p-6 custom-scrollbar space-y-6">
                
                <!-- 1. Core Config (Title, Slug, Type) -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-5">
                    <div class="col-span-1 sm:col-span-2">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Title *</label>
                        <input type="text" x-model="form.title" @input="generateSlug" class="w-full px-3 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-anita-500 outline-none font-bold text-slate-800">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Slug *</label>
                        <input type="text" x-model="form.slug" :disabled="mode === 'edit'" class="w-full px-3 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-anita-500 outline-none disabled:bg-slate-100 disabled:text-slate-500 font-mono text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Content Type *</label>
                        <select x-model="form.type" class="w-full px-3 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-anita-500 outline-none bg-slate-50">
                            <option value="markdown">Markdown (Asta)</option>
                            <option value="html">HTML (Aina)</option>
                        </select>
                    </div>
                </div>

                <!-- 2. Content Editor Action -->
                <div class="bg-slate-50 border border-slate-200 rounded-xl p-4 shadow-sm">
                    <div x-show="form.type === 'markdown'" class="flex flex-col sm:flex-row items-center justify-between gap-4">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 rounded-xl bg-purple-100 text-purple-600 flex items-center justify-center text-2xl shadow-sm"><i class="fas fa-pen-alt"></i></div>
                            <div>
                                <h4 class="font-bold text-slate-800 text-sm">Markdown Content</h4>
                                <p class="text-xs text-slate-500">Edit content using the Asta Editor</p>
                            </div>
                        </div>
                        <!-- <a :href="mode === 'edit' ? '/asta/?slug=' + form.slug : '#'" class="w-full sm:w-auto text-center bg-purple-600 text-white px-6 py-2.5 rounded-lg font-bold text-sm shadow-lg shadow-purple-200 hover:bg-purple-700 transition" :class="mode === 'create' ? 'opacity-50 cursor-not-allowed' : ''">
                            <i class="fas fa-magic mr-2"></i> Open Asta
                        </a> -->
                    </div>

                    <div x-show="form.type === 'html'" class="flex flex-col sm:flex-row items-center justify-between gap-4">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 rounded-xl bg-pink-100 text-pink-600 flex items-center justify-center text-2xl shadow-sm"><i class="fas fa-code"></i></div>
                            <div>
                                <h4 class="font-bold text-slate-800 text-sm">HTML Layout</h4>
                                <p class="text-xs text-slate-500">Design layout using the Aina Builder</p>
                            </div>
                        </div>
                        <!-- <a :href="mode === 'edit' ? '/aina/?slug=' + form.slug : '#'" class="w-full sm:w-auto text-center bg-pink-600 text-white px-6 py-2.5 rounded-lg font-bold text-sm shadow-lg shadow-pink-200 hover:bg-pink-700 transition" :class="mode === 'create' ? 'opacity-50 cursor-not-allowed' : ''">
                            <i class="fas fa-paint-brush mr-2"></i> Open Aina
                        </a> -->
                    </div>
                    <p x-show="mode === 'create'" class="text-center sm:text-right text-[10px] text-red-500 mt-3 sm:mt-1 font-bold uppercase tracking-wide">Save page first to edit content</p>
                </div>

                <!-- 3. Metadata Divider -->
                <div class="relative py-2">
                    <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-slate-200"></div></div>
                    <div class="relative flex justify-center"><span class="px-3 bg-white text-xs font-bold text-slate-400 uppercase tracking-wider">Metadata</span></div>
                </div>

                <!-- 4. Description & Thumb -->
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Description</label>
                        <textarea x-model="form.description" rows="2" class="w-full px-3 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-anita-500 outline-none text-sm"></textarea>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Thumbnail</label>
                        <div class="flex gap-2">
                            <input type="text" x-model="form.thumb" placeholder="/media/image.webp" class="flex-1 px-3 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-anita-500 outline-none text-sm">
                            <label class="bg-slate-100 hover:bg-slate-200 text-slate-600 px-4 py-2 rounded-lg font-bold text-sm border border-slate-200 transition cursor-pointer flex items-center whitespace-nowrap">
                                <i class="fas fa-upload mr-2"></i> Upload
                                <input type="file" class="hidden" accept="image/*" @change="uploadThumbnail">
                            </label>
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Tags</label>
                        <div class="flex flex-wrap gap-2 p-2 border border-slate-200 rounded-lg bg-white focus-within:ring-2 focus-within:ring-anita-500">
                            <template x-for="(tag, index) in form.tags" :key="index">
                                <span class="bg-slate-100 text-slate-700 px-2 py-1 rounded text-xs font-bold flex items-center gap-1 border border-slate-200">
                                    <span x-text="tag"></span>
                                    <button @click="removeTag(index)" class="hover:text-red-500"><i class="fas fa-times"></i></button>
                                </span>
                            </template>
                            <input type="text" x-model="form.tagInput" @keydown.enter.prevent="addTag" placeholder="Add tag..." class="flex-1 min-w-[100px] outline-none text-sm bg-transparent">
                        </div>
                    </div>
                </div>

                <!-- 5. Custom Fields -->
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-xs font-bold text-slate-500 uppercase">Custom Fields</label>
                        <button @click="addCustomField" class="text-xs font-bold text-anita-600 hover:text-anita-700">+ Add Field</button>
                    </div>
                    <div class="space-y-2 bg-slate-50 p-3 rounded-lg border border-slate-100">
                        <template x-for="(field, index) in form.customFields" :key="index">
                            <div class="flex gap-2 items-center">
                                <input type="text" x-model="field.k" placeholder="Key" class="w-1/3 px-3 py-2 border border-slate-200 rounded-lg text-xs outline-none focus:border-anita-500 bg-white">
                                <input type="text" x-model="field.v" placeholder="Value" class="flex-1 px-3 py-2 border border-slate-200 rounded-lg text-xs outline-none focus:border-anita-500 bg-white">
                                <button @click="removeCustomField(index)" class="text-slate-400 hover:text-red-500 p-1"><i class="fas fa-trash"></i></button>
                            </div>
                        </template>
                        <div x-show="form.customFields.length === 0" class="text-center text-xs text-slate-400 italic py-2">No custom fields</div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="px-6 py-4 bg-slate-50 border-t border-slate-100 flex justify-end gap-3 rounded-b-2xl">
                <button @click="modalOpen = false" class="px-4 py-2 text-sm font-bold text-slate-500 hover:text-slate-700 bg-white border border-slate-200 rounded-lg shadow-sm">Cancel</button>
                <button @click="savePage" class="px-6 py-2 bg-slate-900 hover:bg-slate-800 text-white text-sm font-bold rounded-lg shadow-lg">Save Page</button>
            </div>
        </div>
    </div>

    <!-- DELETE MODAL -->
    <div x-show="deleteModalOpen" class="fixed inset-0 z-50 flex items-center justify-center" x-cloak>
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" @click="deleteModalOpen = false"></div>
        <div class="relative bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 text-center animate-float">
            <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-exclamation-triangle text-red-500 text-2xl"></i>
            </div>
            <h3 class="text-lg font-bold text-slate-800 mb-2">Delete Page?</h3>
            <p class="text-sm text-slate-500 mb-6">Delete <span x-text="targetSlug" class="font-mono font-bold text-slate-700"></span>? This cannot be undone.</p>
            <div class="flex justify-center gap-3">
                <button @click="deleteModalOpen = false" class="px-4 py-2 text-sm font-bold text-slate-600 bg-slate-100 rounded-lg hover:bg-slate-200">Cancel</button>
                <button @click="doDelete" class="px-4 py-2 text-sm font-bold text-white bg-red-500 rounded-lg hover:bg-red-600 shadow-lg">Yes, Delete</button>
            </div>
        </div>
    </div>
</body>
</html>