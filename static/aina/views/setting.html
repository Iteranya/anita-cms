<div
    x-data="settingManager('{{ slug }}')"
    class="flex flex-col h-full bg-ide-bg text-gray-300"
    x-init="init()"
>
    <!-- TOP TOOLBAR -->
    <div class="h-14 border-b border-ide-border bg-ide-panel px-6 flex items-center justify-between shrink-0">
        <div>
            <h1 class="text-lg font-bold text-white tracking-tight">Advanced Header & CSP</h1>
            <p class="text-xs text-gray-500">Inject scripts and configure granular Security Policies</p>
        </div>

        <div class="flex items-center gap-4">
            <span class="text-xs font-mono transition-colors duration-300"
                  :class="{
                      'text-green-400': saveStatus === 'Saved',
                      'text-yellow-400': saveStatus === 'Saving...',
                      'text-red-400': saveStatus === 'Error',
                      'text-gray-500': saveStatus === 'Ready'
                  }"
                  x-text="saveStatus">
            </span>

            <button
                @click="saveHead"
                :disabled="isSaving || isLoading"
                class="bg-ide-accent hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed text-white text-xs font-bold px-4 py-2 rounded shadow-sm transition-colors flex items-center gap-2"
            >
                <i class="fas fa-save" :class="isSaving ? 'fa-spin' : ''"></i>
                <span>Save Config</span>
            </button>
        </div>
    </div>

    <div class="flex-1 flex overflow-hidden relative">
        <!-- LOADING OVERLAY -->
        <div x-show="isLoading" class="absolute inset-0 z-30 bg-ide-bg/80 flex items-center justify-center backdrop-blur-sm">
            <div class="text-ide-accent flex flex-col items-center gap-3">
                <i class="fas fa-circle-notch fa-spin text-3xl"></i>
                <span class="text-xs font-mono uppercase tracking-widest">Parsing...</span>
            </div>
        </div>

        <!-- LEFT COLUMN: TABS -->
        <div class="w-1/2 flex flex-col border-r border-ide-border" x-data="{ activeTab: 'header' }">
            <!-- Tab Navigation -->
            <div class="flex border-b border-ide-border bg-[#2d2d2d] shrink-0">
                <button
                    @click="activeTab = 'header'"
                    :class="{'bg-ide-panel text-white': activeTab === 'header', 'text-gray-500 hover:bg-[#3f3f46] hover:text-gray-300': activeTab !== 'header'}"
                    class="flex-1 px-4 py-2.5 text-xs font-bold text-center transition-colors duration-200 focus:outline-none"
                >
                    <i class="fas fa-code mr-1.5 text-ide-accent"></i>
                    Head Content
                </button>
                <button
                    @click="activeTab = 'csp'"
                    :class="{'bg-ide-panel text-white': activeTab === 'csp', 'text-gray-500 hover:bg-[#3f3f46] hover:text-gray-300': activeTab !== 'csp'}"
                    class="flex-1 px-4 py-2.5 text-xs font-bold text-center transition-colors duration-200 focus:outline-none border-l border-ide-border"
                >
                    <i class="fas fa-shield-alt mr-1.5 text-red-400"></i>
                    Content Security Policy
                </button>
            </div>

            <!-- Tab Content -->
            <div class="flex-1 flex flex-col min-h-0">
                <!-- 1. CUSTOM SCRIPTS TAB -->
                <div x-show="activeTab === 'header'" class="flex-1 flex flex-col h-full bg-[#1e1e1e]">
                    <textarea
                        class="w-full h-full bg-[#1e1e1e] text-[#d4d4d4] font-mono text-xs p-4 resize-none focus:outline-none custom-scrollbar"
                        x-model="customHeadContent"
                        @input.debounce.300ms="generatePreview()"
                        placeholder="<!-- Scripts, Styles, Meta tags go here -->"
                    ></textarea>
                </div>

                <!-- 2. CSP CONTROLS TAB -->
                <div x-show="activeTab === 'csp'" class="flex-1 flex flex-col min-h-0 bg-ide-panel overflow-y-auto custom-scrollbar">
                    <div class="px-4 py-3 bg-[#2d2d2d] border-b border-ide-border sticky top-0 z-10 flex items-center justify-between shrink-0">
                         <div class="flex items-center gap-2">
                             <i class="fas fa-shield-alt text-xs text-red-400"></i>
                             <span class="text-sm font-bold text-gray-200">CSP Status</span>
                         </div>
                         <button
                             @click="toggleCSP()"
                             class="w-10 h-5 rounded-full relative transition-colors duration-200 shrink-0"
                             :class="cspState.enabled ? 'bg-red-600' : 'bg-[#3e3e42]'"
                         >
                             <div class="absolute top-0.5 left-0.5 bg-white w-4 h-4 rounded-full shadow-md transition-transform duration-200"
                                  :class="cspState.enabled ? 'translate-x-5' : 'translate-x-0'"></div>
                         </button>
                    </div>
                     <div class="p-6 space-y-8 pb-20">
                         <div x-show="!cspState.enabled" class="text-center py-4 opacity-50">
                             <i class="fas fa-lock-open text-3xl mb-2"></i>
                             <p class="text-xs">CSP is currently disabled.</p>
                         </div>
                          <div x-show="cspState.enabled" x-transition>
                            <!-- Boolean Switches -->
                            <div class="mb-6 flex items-center justify-between bg-[#252526] p-3 rounded border border-ide-border">
                                <div>
                                    <div class="text-xs font-bold text-gray-300">Upgrade Insecure Requests</div>
                                    <div class="text-[10px] text-gray-500">Auto-convert HTTP to HTTPS</div>
                                </div>
                                <input type="checkbox" x-model="cspState.upgradeInsecure" @change="generatePreview()" class="accent-ide-accent">
                            </div>
                             <template x-for="category in ['Essentials', 'Fetch & Resources', 'Embeds & Workers', 'Security Boundaries']">
                                 <div class="mb-10">
                                     <h3 class="text-[11px] uppercase tracking-widest font-bold text-ide-accent mb-4 border-b border-gray-700/50 pb-2" x-text="category"></h3>
                                      <div class="space-y-6">
                                         <template x-for="field in cspFields.filter(f => f.category === category)" :key="field.id">
                                             <div class="group/field bg-[#252526] p-3 rounded border border-transparent transition-colors"
                                                 :class="cspState.active[field.id] ? 'border-ide-border' : 'opacity-60 hover:opacity-100'">
                                                  <!-- Header with Toggle -->
                                                 <div class="flex items-start justify-between mb-2">
                                                     <div>
                                                         <div class="flex items-center gap-2">
                                                             <label class="text-xs font-bold text-gray-200 cursor-pointer select-none"
                                                                 :for="'toggle-' + field.id"
                                                                 x-text="field.label"></label>
                                                             <!-- Status Indicator -->
                                                             <span class="text-[9px] font-mono px-1.5 rounded border"
                                                                 :class="cspState.active[field.id] ? 'bg-green-500/10 text-green-400 border-green-500/20' : 'bg-gray-700 text-gray-500 border-transparent'">
                                                                 <span x-text="cspState.active[field.id] ? 'ON' : 'OFF'"></span>
                                                             </span>
                                                         </div>
                                                         <p class="text-[10px] text-gray-500 mt-0.5 leading-snug max-w-md" x-text="field.description"></p>
                                                     </div>
                                                      <!-- Individual Toggle Switch -->
                                                     <div class="relative inline-block w-8 mr-2 align-middle select-none transition duration-200 ease-in">
                                                         <input type="checkbox"
                                                             :id="'toggle-' + field.id"
                                                             class="toggle-checkbox absolute block w-4 h-4 rounded-full bg-white border-4 appearance-none cursor-pointer transition-transform duration-200 ease-in-out"
                                                             :class="cspState.active[field.id] ? 'translate-x-4 border-ide-accent' : 'translate-x-0 border-gray-400'"
                                                             x-model="cspState.active[field.id]"
                                                             @change="generatePreview()"/>
                                                         <label :for="'toggle-' + field.id"
                                                             class="toggle-label block overflow-hidden h-4 rounded-full cursor-pointer transition-colors duration-200"
                                                             :class="cspState.active[field.id] ? 'bg-ide-accent/50' : 'bg-gray-700'"></label>
                                                     </div>
                                                 </div>
                                                  <!-- Inputs (Only shown if active) -->
                                                 <div x-show="cspState.active[field.id]" x-transition.origin.top class="mt-3 pt-3 border-t border-gray-700/50">
                                                     <div class="flex relative">
                                                         <div class="absolute inset-y-0 left-0 pl-2.5 flex items-center pointer-events-none">
                                                             <span class="text-gray-600 text-xs font-mono opacity-50"><i class="fas fa-plus"></i></span>
                                                         </div>
                                                         <input type="text"
                                                             class="w-full bg-[#1e1e1e] border border-ide-border rounded px-2 pl-7 py-1.5 text-xs text-gray-300 focus:border-ide-accent focus:outline-none placeholder-gray-700 font-mono transition-all focus:ring-1 focus:ring-ide-accent/30"
                                                             :placeholder="field.placeholder"
                                                             @keydown.enter.prevent="addCspDomain(field.id, $event.target.value); $event.target.value = ''"
                                                         >
                                                     </div>
                                                      <!-- Tags List -->
                                                     <div class="flex flex-wrap gap-2 mt-2 min-h-[20px]">
                                                         <!-- Show Default Logic (Visual Only) -->
                                                         <div class="bg-[#3e3e42]/50 text-gray-400 text-[10px] font-mono px-2 py-0.5 rounded border border-transparent italic cursor-help" title="Default value automatically applied">
                                                             'self'
                                                         </div>
                                                          <template x-for="(domain, idx) in cspState.rules[field.id]" :key="idx">
                                                             <div class="bg-[#3e3e42] text-gray-200 text-[10px] font-mono px-2 py-0.5 rounded flex items-center gap-2 border border-transparent hover:border-red-400/50 transition-colors cursor-default">
                                                                 <span x-text="domain"></span>
                                                                 <button @click="removeCspDomain(field.id, idx)" class="text-gray-500 hover:text-red-400 focus:outline-none">
                                                                     <i class="fas fa-times"></i>
                                                                 </button>
                                                             </div>
                                                         </template>
                                                     </div>
                                                 </div>
                                             </div>
                                         </template>
                                     </div>
                                 </div>
                             </template>
                         </div>
                     </div>
                </div>
            </div>
        </div>

        <!-- RIGHT COLUMN: PREVIEW -->
        <div class="w-1/2 flex flex-col bg-[#1e1e1e]">
            <div class="h-8 bg-[#252526] border-b border-ide-border flex items-center px-4 justify-between shrink-0">
                <span class="text-xs font-bold text-gray-400 uppercase tracking-wide">Generated Output</span>
            </div>

            <div class="flex-1 relative group overflow-hidden">
                <textarea
                    readonly
                    class="w-full h-full bg-[#1e1e1e] text-[#9cdcfe] font-mono text-xs p-4 resize-none focus:outline-none leading-relaxed custom-scrollbar selection:bg-[#264f78]"
                    x-text="previewString"
                ></textarea>

                <button
                    @click="navigator.clipboard.writeText(previewString); $store.notifications.add({type:'success', message:'Copied HTML'})"
                    class="absolute top-4 right-4 bg-ide-panel border border-ide-border text-gray-400 hover:text-white px-3 py-1 rounded text-xs opacity-0 group-hover:opacity-100 transition-opacity"
                >
                    <i class="fas fa-copy"></i>
                </button>
            </div>
        </div>
    </div>
</div>