export default (slug) => ({
    // --- Core Data ---
    slug: slug,
    isLoading: false,
    routes: [],
    categories: {},
    selectedSlugs: new Set(),

    // --- UI State ---
    activeCategory: 'All',
    searchQuery: '',
    autosaveStatus: 'Ready',
    saveTimeout: null,

    async init() {
        if (!this.slug) {
            console.error("Error: Slug is missing.");
            return;
        }
        await this.fetchRoutes();
        await this.loadCurrentState();
    },

    // --- Data Fetching ---
    async fetchRoutes() {
        this.isLoading = true;
        try {
            const data = await this.$api.aina.getRoutes().execute();
            this.routes = data;
            
            this.categories = data.reduce((acc, item) => {
                const cat = item.category || 'Uncategorized';
                if (!acc[cat]) acc[cat] = [];
                acc[cat].push(item);
                return acc;
            }, {});
        } catch (error) {
            console.error("Generator load error", error);
        } finally {
            this.isLoading = false;
        }
    },

    async loadCurrentState() {
        try {
            const response = await this.$api.aina.get(this.slug).execute();
            const currentScript = response.custom?.builder?.script || "";
            
            this.selectedSlugs.clear();

            // Regex: // [AINA:slug]
            const regex = /\/\/ \[AINA:([^\]]+)\]/g;
            let match;
            
            while ((match = regex.exec(currentScript)) !== null) {
                const foundSlug = match[1];
                if (this.routes.some(r => r.slug === foundSlug)) {
                    this.selectedSlugs.add(foundSlug);
                }
            }
            this.selectedSlugs = new Set(this.selectedSlugs); // Reactivity trigger
        } catch (e) { 
            console.log("No existing script found", e); 
        }
    },

    // --- Getters (Standard) ---
    get filteredItems() {
        let items = this.routes;
        if (this.activeCategory !== 'All' && this.activeCategory !== 'Media') {
            items = items.filter(r => (r.category || 'Uncategorized') === this.activeCategory);
        }
        if (this.searchQuery) {
            const q = this.searchQuery.toLowerCase();
            items = items.filter(r => r.name.toLowerCase().includes(q));
        }
        return items;
    },

    get codeRoutes() { return this.filteredItems.filter(r => !this.isMedia(r)); },
    get mediaRoutes() { 
        let items = this.routes.filter(r => this.isMedia(r));
        if (this.searchQuery) items = items.filter(r => r.name.toLowerCase().includes(this.searchQuery.toLowerCase()));
        return items;
    },
    get activeComponentsList() { return this.routes.filter(r => this.selectedSlugs.has(r.slug)); },

    // --- Helpers ---
    
    // [ADDED THIS HELPER] - This was missing and caused your error
    isSelected(slug) {
        return this.selectedSlugs.has(slug);
    },

    isMedia(route) { return route.data && route.data.includes('mediaUrl'); },
    extractUrl(jsString) { const match = jsString.match(/mediaUrl:\s*'([^']+)'/); return match ? match[1] : null; },

    toggleComponent(slug) {
        if (this.selectedSlugs.has(slug)) {
            this.selectedSlugs.delete(slug);
        } else {
            this.selectedSlugs.add(slug);
        }
        this.selectedSlugs = new Set(this.selectedSlugs); // Reactivity fix
        this.triggerAutosave();
    },

    // --- Autosave Logic ---

    triggerAutosave() {
        this.autosaveStatus = 'Saving...';
        if (this.saveTimeout) clearTimeout(this.saveTimeout);

        this.saveTimeout = setTimeout(() => {
            this.applyChanges();
        }, 1000);
    },

    async applyChanges() {
        const selectedRoutes = this.routes.filter(r => this.selectedSlugs.has(r.slug));
        let fullScript = `/**\n * Auto-Generated by Aina\n * Updated: ${new Date().toISOString()}\n */\n\n`;
        
        selectedRoutes.forEach(route => {
            fullScript += `// [AINA:${route.slug}]\n`;
            fullScript += `// --- ${route.name} ---\n`;
            fullScript += route.data.trim();
            fullScript += `\n// [/AINA:${route.slug}]\n\n`;
        });

        try {
            const currentData = await this.$api.aina.get(this.slug).execute();
            const existingBuilder = currentData.custom?.builder || {};

            const payload = {
                custom: {
                    builder: {
                        ...existingBuilder,
                        script: fullScript
                    }
                }
            };

            await this.$api.aina.updateHTML().execute(this.slug, payload);

            this.autosaveStatus = 'Saved';
            setTimeout(() => { 
                if(this.autosaveStatus === 'Saved') this.autosaveStatus = 'Ready'; 
            }, 2000);

        } catch (error) {
            console.error("Generator Save Failed:", error);
            this.autosaveStatus = 'Error';
        }
    }
});