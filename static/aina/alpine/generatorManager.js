export default (slug) => ({
    // Core Data
    slug: slug,
    isLoading: false,
    routes: [],
    categories: {},
    selectedSlugs: new Set(),

    // UI State (Moved from HTML)
    activeCategory: 'All',
    searchQuery: '',
    
    async init() {
        await this.fetchRoutes();
        await this.loadCurrentState();
    },

    // --- Data Fetching ---

    async fetchRoutes() {
        this.isLoading = true;
        try {
            const data = await this.$api.aina.getRoutes().send();
            this.routes = data;
            
            // Group by category
            this.categories = data.reduce((acc, item) => {
                const cat = item.category || 'Uncategorized';
                if (!acc[cat]) acc[cat] = [];
                acc[cat].push(item);
                return acc;
            }, {});
        } catch (error) {
            console.error("Generator load error", error);
            if(this.$store.notifications) this.$store.notifications.add({ type: 'error', message: 'Failed to load library' });
        } finally {
            this.isLoading = false;
        }
    },

    async loadCurrentState() {
        try {
            const response = await this.$api.aina.get(this.slug).send();
            const currentScript = response.custom?.builder?.script || "";
            
            this.routes.forEach(route => {
                const safeSlug = route.slug.replace(/-/g, '_');
                // Check if the unique function definition exists in the script
                if (currentScript.includes(`'${safeSlug}'`) || 
                    currentScript.includes(`"${safeSlug}"`) || 
                    currentScript.includes(`list_${safeSlug.replace('list_', '')}`)) {
                    this.selectedSlugs.add(route.slug);
                }
            });
        } catch (e) {
            console.log("No existing script found");
        }
    },

    // --- Computed Logic (The "Getter") ---

    get visibleRoutes() {
        let items = this.routes;
        
        // 1. Filter by Category
        if (this.activeCategory !== 'All') {
            items = items.filter(r => (r.category || 'Uncategorized') === this.activeCategory);
        }
        
        // 2. Filter by Search Query
        if (this.searchQuery) {
            const q = this.searchQuery.toLowerCase();
            items = items.filter(r => r.name.toLowerCase().includes(q));
        }
        
        return items;
    },

    // --- Helpers ---

    isMedia(route) {
        return route.data && route.data.includes('mediaUrl');
    },

    extractUrl(jsString) {
        const match = jsString.match(/mediaUrl:\s*'([^']+)'/); 
        return match ? match[1] : null; 
    },

    toggleComponent(slug) {
        if (this.selectedSlugs.has(slug)) {
            this.selectedSlugs.delete(slug);
        } else {
            this.selectedSlugs.add(slug);
        }
    },

    isSelected(slug) {
        return this.selectedSlugs.has(slug);
    },

    // --- Actions ---

    async applyChanges() {
        this.isLoading = true;
        
        // 1. Compile Script
        const selectedRoutes = this.routes.filter(r => this.selectedSlugs.has(r.slug));
        let fullScript = `/**\n * Auto-Generated by Aina\n * Updated: ${new Date().toISOString()}\n */\n\n`;
        
        selectedRoutes.forEach(route => {
            fullScript += `// --- ${route.name} ---\n`;
            fullScript += route.data + "\n\n";
        });

        // 2. Send to Server
        const payload = {
            custom: {
                builder: {
                    script: fullScript
                }
            }
        };

        try {
            await this.$api.aina.updateHTML(this.slug, payload);
            this.$store.notifications.add({ type: 'success', message: 'Script updated in Database.' });
        } catch (error) {
            console.error("Script save error:", error);
            this.$store.notifications.add({ type: 'error', message: 'Failed to save script.' });
        } finally {
            this.isLoading = false;
        }
    },

    copySnippet(route) {
        let componentName = route.slug.replace(/-/g, '_');
        if (route.slug.startsWith('list-')) componentName = 'list_' + route.slug.replace('list-', '').replace(/-/g, '_');
        if (route.slug.startsWith('editor-')) componentName = 'editor_' + route.slug.replace('editor-', '').replace(/-/g, '_');
        
        const tag = `<div x-data="${componentName}"></div>`;
        
        navigator.clipboard.writeText(tag);
        this.$store.notifications.add({ type: 'info', message: 'Tag copied to clipboard' });
    }
});