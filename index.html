<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asta Editor â€“ {{slug}}</title>

    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- AlpineJS (from your asta.js) & Editor Libs -->
    <script src="/static/hikarin/lib/asta.js"></script>
    <script type="module" src="/static/asta/main.js"></script>

    <script>
        tailwind.config = {
            // No dark mode needed for this theme
            theme: {
                extend: {
                    fontFamily: { sans: ['Nunito', 'sans-serif'] },
                    colors: {
                        anita: { 50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7', 900: '#0c4a6e' }
                    }
                }
            }
        }
    </script>

    <style>
        [x-cloak] { display: none !important; }

        /* --- Dynamic Background Blobs --- */
        @keyframes float {
            0%, 100% { transform: translate(0,0); }
            33% { transform: translate(30px,-50px); }
            66% { transform: translate(-20px,20px); }
        }
        .animate-blob { animation: float 10s infinite ease-in-out; }
        .blob { position:absolute; filter:blur(90px); opacity:0.6; border-radius:50%; }
        
        /* --- Modern Glass Panel Effect (Light Theme) --- */
        .glass-panel {
            background: rgba(255,255,255,0.75);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255,255,255,0.8);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.05);
        }

        /* --- Editor Specific Styles --- */
        .editor-container {
            height: 100%;
            cursor: text;
        }
        .editor-container .milkdown { 
            height: 100%; 
            display: flex; 
            flex-direction: column; 
        }
        /* Ensure ProseMirror (the editor text area) has a transparent background to see the container's bg */
        .editor-container .milkdown .ProseMirror { 
            flex-grow: 1; 
            outline: none; 
            height: 100%;
            background: transparent;
        }
        
    </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans antialiased">

    <!-- Animated Background Blobs -->
    <div class="fixed top-0 left-0 w-full h-full overflow-hidden -z-10">
        <div class="blob bg-anita-500 w-96 h-96 top-1/4 left-1/4 animate-blob" style="animation-delay: 2s;"></div>
        <div class="blob bg-purple-500 w-72 h-72 top-1/2 left-1/2 animate-blob"></div>
        <div class="blob bg-pink-500 w-80 h-80 top-1/3 right-1/4 animate-blob" style="animation-delay: 4s;"></div>
    </div>


    <!-- 
        Main Alpine Component
        - Manages editor data via `editorManager`
        - Manages UI state for the preview sidebar via `isPreviewVisible`
        - CORRECTED: Merges both data sources into a single object to fix scope issues.
    -->
    <div 
        class="flex flex-col h-screen" 
        x-data="{ ...editorManager('{{slug}}'), isPreviewVisible: false }" 
        x-init="init()"
        x-cloak
    >

        <!-- TOP ACTION BAR -->
        <header class="glass-panel w-full max-w-7xl mx-auto mt-4 rounded-xl z-10">
            <div class="flex items-center justify-between p-3 px-6">
                <!-- Left: Title & Status -->
                <div class="flex items-center gap-4">
                    <h1 class="font-bold text-lg text-gray-900">
                        <i class="fa-solid fa-feather-pointed text-anita-600"></i>
                        Editing: <span class="font-mono text-base text-gray-700">{{slug}}</span>
                    </h1>
                    <span 
                        class="text-xs font-mono px-3 py-1 bg-gray-100 border border-gray-200 rounded-full text-gray-600 transition-colors"
                        :class="{ 'text-yellow-600 border-yellow-200 bg-yellow-50': statusText === 'Unsaved changes', 'text-green-600 border-green-200 bg-green-50': statusText.includes('Saved') || statusText.includes('Deployed'), 'text-red-600 border-red-200 bg-red-50': statusText.includes('Error') }"
                        x-text="statusText">
                    </span>
                </div>

                <!-- Right: Action Buttons -->
                <div class="flex items-center gap-3">
                    <button 
                        @click="syncDraft()" 
                        :disabled="isProcessing"
                        class="px-4 py-2 text-sm font-bold text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-100 transition disabled:opacity-50 disabled:cursor-wait"
                        title="Save Draft (custom.crepe)">
                        <i class="fa-solid fa-floppy-disk mr-2"></i>
                        Save Draft
                    </button>
                    <button 
                        @click="deploy()"
                        :disabled="isProcessing"
                        class="px-4 py-2 text-sm font-bold text-white bg-anita-600 rounded-lg hover:bg-anita-500 transition disabled:opacity-50 disabled:cursor-wait"
                        title="Publish to live page">
                        <i class="fa-solid fa-rocket mr-2"></i>
                        Publish
                    </button>
                    <div class="w-px h-6 bg-gray-300 mx-2"></div>
                    <button 
                        @click="isPreviewVisible = !isPreviewVisible"
                        class="px-3 py-2 text-sm font-bold text-gray-600 bg-white border border-gray-300 rounded-lg hover:bg-gray-100 transition"
                        :class="{ 'bg-anita-100 text-anita-600 border-anita-200': isPreviewVisible }"
                        title="Toggle Markdown Preview">
                        <i class="fa-solid fa-eye"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- MAIN CONTENT AREA -->
        <main class="flex-grow flex p-4 gap-4 overflow-hidden">
            
            <!-- The Editor Canvas -->
            <div 
                 class="flex-grow bg-white rounded-xl shadow-xl border border-gray-200/50 overflow-y-auto transition-all duration-300 p-8 editor-container"
                 :class="{ 'max-w-full': !isPreviewVisible, 'w-1/2': isPreviewVisible }"
                 @click="focusEditor($event)"
            >
                <div x-ref="editorRoot" class="h-full"></div>
            </div>

            <!-- Hidden Markdown Preview Sidebar -->
            <aside 
                x-show="isPreviewVisible"
                x-transition:enter="transition ease-out duration-300"
                x-transition:enter-start="opacity-0 translate-x-8"
                x-transition:enter-end="opacity-100 translate-x-0"
                x-transition:leave="transition ease-in duration-200"
                x-transition:leave-start="opacity-100 translate-x-0"
                x-transition:leave-end="opacity-0 translate-x-8"
                class="w-1/2 h-full glass-panel rounded-xl flex flex-col"
            >
                <div class="p-4 border-b border-gray-200">
                    <p class="text-sm font-bold text-gray-600">
                        <i class="fa-brands fa-markdown mr-2"></i>
                        MARKDOWN PREVIEW
                    </p>
                </div>
                <div class="p-6 flex-grow overflow-auto">
                    <pre class="text-indigo-900 font-mono text-sm whitespace-pre-wrap" x-text="content"></pre>
                </div>
            </aside>

        </main>
    </div>

</body>
</html>